# Valkey helm chart

A Helm chart for building and deploying a [Valkey](https://github/sclorg/valkey-container) application on OpenShift.

For more information about helm charts see the official [Helm Charts Documentation](https://helm.sh/).

You need to have access to a cluster for each operation with OpenShift 4, like deploying and testing.

## Values
Below is a table of each value used to configure this chart.

| Value                   | Description                                                 | Default                     | Additional Information |
|-------------------------|-------------------------------------------------------------|-----------------------------| ---------------------- |
| `database_service_name` | The name of the OpenShift Service exposed for the database. | `valkey`                    | - |
| `valkey_password`       | Password for the Valkey connection user.                    |                             | Expression like: `[a-zA-Z0-9]{16}` |
| `valkey_version`        | Version of Valkey image to be used (8-el10, 8-el9, or latest). | `8-el10`                 |  |
| `namespace`             | The OpenShift Namespace where the ImageStream resides.      | `valkey-persistent-testing` | |
| `memory_limit`          | Maximum amount of memory the container can use.             | `512Mi`                     |  |
| `pvc.volume_capacity`   | Volume space available for data, e.g. 512Mi, 2Gi.          | `1Gi`                       |  |
| `pvc.netapp_nfs`        | Use NetApp NFS storage class.                               | `false`                     |  |
| `pvc.app_code`          | Application code label for NetApp NFS PVC.                  | `something`                 |  |
| `tls.enabled`           | Enable TLS encryption for Valkey connections.               | `true`                      |  |
| `tls.autoGenerated`     | Use OpenShift Service CA to auto-generate TLS certificates. | `true`                      |  |
| `tls.secretName`        | Name of the secret containing tls.crt and tls.key.         | `valkey-tls`                |  |

## TLS Support

This chart supports optional TLS encryption using OpenShift's Service CA mechanism.

When `tls.enabled` and `tls.autoGenerated` are both `true` (the default), the chart:

1. Annotates the Service with `service.beta.openshift.io/serving-cert-secret-name`, which tells OpenShift to auto-generate a TLS certificate and store it in the named secret.
2. Mounts the TLS secret into the Valkey container at `/tls/`.
3. Configures Valkey to listen on port **6380** for TLS connections (port 6379 remains available for non-TLS).
4. Creates a ConfigMap (`<service-name>-service-ca`) annotated with `service.beta.openshift.io/inject-cabundle: "true"`, which OpenShift populates with the Service CA bundle for client trust.

### Connecting from a client application

Mount the Service CA ConfigMap in your client pod:

```yaml
volumeMounts:
  - name: service-ca
    mountPath: /etc/ssl/service-ca
    readOnly: true
volumes:
  - name: service-ca
    configMap:
      name: valkey-service-ca
```

Connect using the CA bundle for certificate verification:

```bash
valkey-cli -h valkey.<namespace>.svc -p 6380 \
  --tls --cacert /etc/ssl/service-ca/service-ca.crt \
  -a <password> ping
```

No client certificate is required (`--tls-auth-clients` is set to `no`).
