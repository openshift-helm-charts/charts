# OpenShift Helm Charts Repository

OpenShift Helm Charts Repository is the canonical source of all the certified
Helm charts from [partners][partners].  Once your chart is ready for submission,
you can submit a pull request.  The pull request can include the chart and/or a
report generated by the [chart-verifier][chart-verifier] tool.  Based on the
content, the chart will be certified, and the chart-verifier will be run if a
report is not provided.

After merging your pull request, the CI/CD pipeline will publish the chart in
the GitHub releases and add it to the Helm [charts repository index][index-url].
If you are submitting the report without a chart, the report must contain a URL
pointing to the downloadable location of the chart.  In this case, the Helm
charts repository index will include the download URL and other chart metadata
available in the report.  If you want the chart published through GitHub but do
not want the CI/CD pipeline running chart-verifier against your chart, you can
submit a chart and the report together.

---

<!-- To generate: gh-md-toc --no-backup --hide-footer README.md -->

**Table of Contents:**

<!--ts-->
* [OpenShift Helm Charts Repository](#openshift-helm-charts-repository)
   * [Submitting Chart Related Changes](#submitting-chart-related-changes)
      * [Preparation](#preparation)
      * [Submitting a Chart without Chart Verification Report](#submitting-a-chart-without-chart-verification-report)
      * [Submitting a Chart Verification Report without the Chart](#submitting-a-chart-verification-report-without-the-chart)
      * [Submitting a Chart Verification Report with the Chart](#submitting-a-chart-verification-report-with-the-chart)
   * [Post Submission Manual Review](#post-submission-manual-review)
   * [Troubleshooting Pull Request Failures](#troubleshooting-pull-request-failures)
      * [Error when submitting files not part of any chart](#error-when-submitting-files-not-part-of-any-chart)
      * [Missing OWNERS file in the chart directory](#missing-owners-file-in-the-chart-directory)
      * [Pull request author is not part of OWNERS file](#pull-request-author-is-not-part-of-owners-file)
      * [Vendor label mismatch with the directory structure](#vendor-label-mismatch-with-the-directory-structure)
      * [Chart name mismatch with the directory structure](#chart-name-mismatch-with-the-directory-structure)
      * [Error when submitting both chart source and tarball](#error-when-submitting-both-chart-source-and-tarball)
      * [Error when submitting files not related to any chart](#error-when-submitting-files-not-related-to-any-chart)
      * [Error when digest in the report is not matching with the chart digest](#error-when-digest-in-the-report-is-not-matching-with-the-chart-digest)
      * [Error with the chart URL when submitting report](#error-with-the-chart-url-when-submitting-report)
      * [Chart name and version mismatch errors](#chart-name-and-version-mismatch-errors)
      * [Report failures](#report-failures)
   * [Frequently Asked Questions](#frequently-asked-questions)
      * [Can I test the pull request in my fork before submitting?](#can-i-test-the-pull-request-in-my-fork-before-submitting)
      * [Can I use any command-line interface to create pull request?](#can-i-use-any-command-line-interface-to-create-pull-request)
      * [How to update OWNERS file?](#how-to-update-owners-file)
   * [Support](#support)
<!--te-->

---

## Submitting Chart Related Changes

In a nutshell, these are the actions that are performed when you submit a chart.
The pull request is checked for non-chart-related changes and fails the job if
found.  A check performs the chart is added to a correct directory path.  If a
report is provided, confirm all mandatory checks are present and have passed.
If a chart is provided, check the digest in the report to match the digest
calculated for the submitted chart.  If a report is not provided, run the
chart-verifier and confirm all mandatory checks pass.

You can submit chart related changes in three methods:

1. Submit a chart without Chart Verification Report

   - Chart as a tarball
   - Chart in a directory

2. Submit a Chart Verification Report without the Chart
3. Submit a Chart Verification Report with the Chart

The following sections explains about the process for submission.

### Preparation

To submit a pull request, you need to fork the Git repository and clone it to
your local system.  If you had followed the [partner connect
documentation][partners], you should see an _OWNERS_ file under your chart
directory within your organization directory.

For Red Hat and Community charts, first submit a PR towards `main` branch with an _OWNERS_ file under your chart directory within your orgranization directory.

You should see the `OWNERS` file at:

```
charts/partners/acme/awesome/OWNERS
```

For example, if the organization name is `acme` and the chart name is `awesome`.
The content of the OWNERS file is going to be something like this:

```
chart:
  name: awesome
  shortDescription: A Helm chart for Awesomeness
publicPgpKey: null
users:
  - githubUsername: <username-one>
  - githubUsername: <username-two>
vendor:
  label: acme
  name: ACME Inc.
```

The name of the chart that you are submitting must match the value in the
`OWNERS` file.  The following section explains how to submit a chart source.
And the section followed describes how to submit a chart verification
report—finally submitting a chart and the report together.

Before submitting chart source or chart verification report, create a directory
with the version number as the name.  For example, if you are publishing the
`0.1.0` version of the `awesome` chart, create a directory like this:

```
charts/partners/acme/awesome/0.1.0/
```


### Submitting a Chart without Chart Verification Report

The chart could be a tarball created using the `helm package` command or a
directory with the chart source.  If it is a tarball, it can be placed directly
under the `0.1.0` directory.

```
charts/partners/acme/awesome/0.1.0/awesome-0.1.0.tgz
```

If the chart is a directory with the chart source, create an `src` directory to
place the chart source.

Here is an example path:

```
charts/partners/acme/awesome/0.1.0/src/
```

The file structure looks like this:

```
.
└── src
    ├── Chart.yaml
    ├── README.md
    ├── templates
    │   ├── deployment.yaml
    │   ├── _helpers.tpl
    │   ├── hpa.yaml
    │   ├── ingress.yaml
    │   ├── NOTES.txt
    │   ├── serviceaccount.yaml
    │   ├── service.yaml
    │   └── tests
    │       └── test-connection.yaml
    ├── values.schema.json
    └── values.yaml
```

### Submitting a Chart Verification Report without the Chart

[Generate the report][chart-verifier] and save it under `0.1.0` with a given
file name as `report.yaml`.

When you follow the [partner connect documentation][partners], you could see
details about adding a PGP public key.  Adding PGP public key is optional.  But
if you have added that, you should see your public key in the _OWNERS_ file
under your chart directory within your organization directory.  The PGP public
key is available in the `publicPgpKey` attribute.  The value of that attribute
must be conforming to [ASCII armor format][ascii-armor].

When submitting a chart verification report without the chart, you can sign your
report and save the signature in [ASCII armor format][ascii-armor].

```
gpg --sign --armor --detach-sign --output report.yaml.asc report.yaml
```

There will be `[WARNING]` message in the console if the signature verification
fails.

### Submitting a Chart Verification Report with the Chart

You can also submit a chart and the report together.  As mentioned in the
"Submitting a Chart without Chart Verification Report" section, place the source
or tarball under the version numbered directory.  Similarly, as mentioned in the
"Submitting a Chart Verification Report without the Chart" section, place
`report.yaml` also under the save under the version numbered directory.

As mentioned in the previous section, optionally, you can sign the report.
There will be `[WARNING]` message in the console if the signature verification
fails.

## Post Submission Manual Review

After submitting the pull request, it will take a few minutes to run all the
checks and merge the PR automatically.  These are the manual review steps you
can perform after creating the pull request.

1. Watch the newly opened pull request for any messages.
2. If there is a message with errors, you can go to the next section,
   [Troubleshooting Pull Request
   Failures](#troubleshooting-pull-request-failures), to get more details.  Once
   you identify the problem, you can update the pull request with the necessary
   changes.
2. If there is a success message that indicates the chart repository index has
   been updated successfully.  You can verify it by checking the latest commit
   in the `gh-pages` branch.  The commit message will be in this format:
   `<partner-label>-<chart-name>-<version-number> index.yaml (#<PR-number>)`
   (e.g, `acme-psql-service-0.1.1 index.yaml (#7)`).  Your chart-related changes
   must be reflected in the `index.yaml` file.
3. If you have submitted a chart source, a GitHub release with the chart and
   corresponding report will be made available in the [GitHub releases
   page](https://github.com/openshift-helm-charts/charts/releases).  The release
   tag will be in this format: `<partner-label>-<chart-name>-<version-number>`
   (e.g., `acme-psql-service-0.1.1`).
4. The chart must be available through the official repository URL:
   https://charts.openshift.io .  You can follow the instruction given there to
   install it in your OpenShift cluster.

## Troubleshooting Pull Request Failures

After submitting the pull request, you can keep the pull request page open to
observe the results.  If there is no issue with the pull request, it is going go
be merged automatically.

If there is an issue, a comment with details will appear in the pull request.
At the bottom of the page, you will also see a box with a heading like this:
"Some checks were not successful" or "All checks have failed".  And below that,
checks are marked with the "required" label to merge the PR automatically:

> CI / Chart Certification (pull_request_target)            [Details](#)

The first part of Chart Certification (Sanity Check) fails if the pull request
contains changes not related to any chart.  This check performs using the script
already part of the upstream repository.  That way, it will ensure the pull
request author is not modifying the verification scripts themselves.  Sanity
check also ensures the chart version submitted is not already released
earlier. The job will fail if any sanity checks fail.

The second part of Chart Certification (Verify PR) performs all the necessary
checks to merge the pull request.  The following sections explain various errors
produced by the Verify PR.

The third part of Chart Certification makes the chart release and update
`index.yaml` in the repository.

### Error when submitting files not part of any chart

If you try to submit changes that are not related to any particular chart, you
will receive an error like this:

```
[ERROR] One or more files included in the pull request are not part of the chart
```

Please ensure you are making changes inside the chart version directory.  For
example, if you are partner the location is going to be here:

```
charts/partners/<organization-name>/<chart-name>/<version-number>
```

Here is an example directory:

```
charts/partners/acme/awesome/0.1.0
```

In the above example, the name of the partner is `acme`, the chart name is
`awesome`, and version number is `0.1.0`.

### Missing OWNERS file in the chart directory

The `OWNERS` file is created through the Red Hat [partner connect
program][partners] and is a prerequisite for submitting a chart.  If it does not
exist for a submitted chart you will see an error:

```
[ERROR] .../OWNERS file does not exist.
```

You can follow the [partner connect documentation][partners] to create the
`OWNERS` file.

### Pull request author is not part of OWNERS file

Every chart directory has an `OWNERS` file.  The process to create that file is
explained in the [chart submissoion preparation](#preparation) section.  Before
submitting the pull request, you need to ensure your GitHub username is part of
that file.  If that is not the case, you will get an error like this.

```
[ERROR] {usernmae} is not allowed to submit the chart on behalf of {organization}
```

You can follow the [partner connect documentation][partners] to update the
`OWNERS` file.

### Vendor label mismatch with the directory structure

The directory structure and the value of vendor label in the `OWNERS` file must
match.  Otherwise you will see an error like this:

```
[ERROR] vendor/label in OWNERS file ({vendor_label}) doesn't match the directory structure (charts/{category}/{organization}/{chart})
```

If the vendor label in the `OWNERS` file is wrong, you can follow the [partner
connect documentation][partners] to update the `OWNERS` file.

If the directory structure (organization name) is wrong, please reach out to
[Technology Partner Success Desk][partner-success-desk].

### Chart name mismatch with the directory structure

The directory structure and the value of chart name in the `OWNERS` file must
match.  Otherwise you will see an error like this:

```
[ERROR] chart/name in OWNERS file ({chart_name}) doesn't match the directory structure (charts/{category}/{organization}/{chart})
```

If the chart name in the `OWNERS` file is wrong, you can follow the [partner
connect documentation][partners] to update the `OWNERS` file.

If the directory structure (chart name) is wrong, please reach out to
[Technology Partner Success Desk][partner-success-desk].

### Error when submitting both chart source and tarball

When submitting a chart, it should be either a tarball or the chart source
dirctory.  Otherwise, you will see an error like this:

```
[ERROR] Both chart source directory and tarball should not exist
```

As a fix, you can either remove the tarball or the chart source directory.

### Error when submitting files not related to any chart


Earlier there was an [error when submitting files not part of any
chart](#error-when-submitting-files-not-part-of-any-chart).  But that check was
checking files outside the chart version directory.  If you make a change within
chart directory but not making any chart related changes, you will see and error
like this:

```
[ERROR] One of these must be modifed: report, chart source, or tarball
```

Please ensure the file names are as described in the documentation above.

### Error when digest in the report is not matching with the chart digest

You will see an error like this when digest in the report is not matching with
the chart digest:

```
[ERROR] Digest is not matching: {submitted_digest}, {generated_digest}
```

Please ensure you have not modified the chart after generating report.  If you
see the above error, run the [chart-verifier][chart-verifier] once again and
update your pull request.

### Error with the chart URL when submitting report

When you submit a chart verification report without the chart, the report must
have a valid URL.

These are the possible errors when there is an issue with the URL:

```
Invalid schema: {chart_url}
Invalid URL: {chart_url}
Missing schema in URL: {chart_url}
```

Please ensure the report is generated by running the
[chart-verifier][chart-verifier] against the URL.

### Chart name and version mismatch errors

The chart name and version number in the `report.yaml`, `Chart.yaml`, directory
path names should be consistent.  Otherwise you will see these kind of error
messages:

```
[ERROR] Chart name ({submitted_report_chart_name}) doesn't match the directory structure (charts/{category}/{organization}/{chart}/{version})
[ERROR] Chart version ({submitted_report_chart_version}) doesn't match the directory structure (charts/{category}/{organization}/{chart}/{version})
[ERROR] Chart name in the chart is not matching against the value in the report: {submitted_report_chart_name} vs {report_chart_name}
[ERROR] Chart version in the chart is not matching against the value in the report: {submitted_report_chart_version} vs. {report_chart_version}
[ERROR] Chart name ({report_chart_name}) doesn't match the directory structure (charts/{category}/{organization}/{chart}/{version})
[ERROR] Chart version ({report_chart_version}) doesn't match the directory structure (charts/{category}/{organization}/{chart}/{version})
[ERROR] Chart Version '{report_version}' doesn't match the version in the directory path: '{version}'
```

### Report failures

If you see an errors like this, please ensure you are using the latest version
of [chart-verifier][chart-verifier] tool.

```
[ERROR] YAML error: ...
[ERROR] Unexpected error: ...
[ERROR] Error analysing the report: ...
[ERROR] Missing annotation in chart/report: {annotation}
```

If the error is still persisting after upgrading to latest chart-verifier,
please contact [Technology Partner Success Desk][partner-success-desk].

If the report has some failure, it will be displayed like this:

```
[ERROR] Report has failed.
Number of checks passed:
Number of checks failed:
Error message: ..
```

To fix the above failure, you need to modify the chart as per the failure
messages.

## Frequently Asked Questions

### Can I test the pull request in my fork before submitting?

Yes, you can do it.

1. Ensure the `main` branch in your fork is updated with the latest changes.
2. Ensure there is a `gh-pages` branch in your fork.
3. You need a publicly accessible OpenShift cluster (See [partner guide to get
   free access to OCP][partner-ocp]).
4. Follow the [documentation to create a service account][sa-cluster-token] and
   corresponding token.  The token should be stored as an [encrypted secret in
   GitHub repository settings][encrypted-secret] with the key as
   `CLUSTER_TOKEN`.  Follow the same document to create `API_SERVER` secret key.
5. Create a branch, make the required chart changes and send a pull request to
   your fork's `main` branch.  You should see the results in your fork as
   explained in this document.

### Can I use any command-line interface to create pull request?

Yes, you can use the [GitHub CLI to create pull request][gh-cli-pr].

### How to update OWNERS file?

Partners can refer to the [partner documentation][partners].

For Red Hat and Community charts, submit a PR towards `main` branch with an _OWNERS_ file under your chart directory within your orgranization directory.

## Support

You can use the issue tracker in this repository to report bugs.  If you are a
partner, please refer to the [Technology Partner Success Desk
documentation][partner-success-desk].

---

[^Top](#openshift-helm-charts-repository)

[partners]: https://redhat-connect.gitbook.io/certification-guides/
[chart-verifier]: https://github.com/redhat-certification/chart-verifier
[index-url]: https://charts.openshift.io
[pat]: https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token
[encyrpted-secret]: https://docs.github.com/en/actions/reference/encrypted-secrets
[gh-cli-pr]: https://cli.github.com/manual/gh_pr_create
[partner-success-desk]: https://redhat-connect.gitbook.io/red-hat-partner-connect-general-guide/managing-your-account/getting-help/technology-partner-success-desk
[new-issue]: https://github.com/openshift-helm-charts/repo/issues/new/choose
[ascii-armor]: https://www.redhat.com/sysadmin/creating-gpg-keypairs
[partner-ocp]: https://redhat-connect.gitbook.io/red-hat-partner-connect-general-guide/benefits/software-access
[sa-cluster-token]: https://github.com/openshift-helm-charts/charts/blob/main/scripts/README.md
[encrypted-secret]: https://docs.github.com/en/actions/reference/encrypted-secrets
